# ğŸ“˜ TÃ€I LIá»†U MODULE DC DRIVER - STM32F103C8T6

## ğŸ“‹ Má»¤C Lá»¤C
1. [Tá»•ng quan há»‡ thá»‘ng](#1-tá»•ng-quan-há»‡-thá»‘ng)
2. [Pháº§n cá»©ng sá»­ dá»¥ng](#2-pháº§n-cá»©ng-sá»­-dá»¥ng)
3. [SÆ¡ Ä‘á»“ kiáº¿n trÃºc pháº§n má»m](#3-sÆ¡-Ä‘á»“-kiáº¿n-trÃºc-pháº§n-má»m)
4. [SÆ¡ Ä‘á»“ giáº£i thuáº­t](#4-sÆ¡-Ä‘á»“-giáº£i-thuáº­t)
5. [Báº£n Ä‘á»“ thanh ghi Modbus](#5-báº£n-Ä‘á»“-thanh-ghi-modbus)
6. [Chi tiáº¿t chá»©c nÄƒng](#6-chi-tiáº¿t-chá»©c-nÄƒng)
7. [HÆ°á»›ng dáº«n sá»­ dá»¥ng](#7-hÆ°á»›ng-dáº«n-sá»­-dá»¥ng)

---

## 1. Tá»”NG QUAN Há»† THá»NG

### 1.1. MÃ´ táº£ chung
Module DC Driver lÃ  má»™t há»‡ thá»‘ng Ä‘iá»u khiá»ƒn Ä‘á»™ng cÆ¡ DC kÃ©p Ä‘Æ°á»£c thiáº¿t káº¿ dá»±a trÃªn vi Ä‘iá»u khiá»ƒn STM32F103C8T6. Module cung cáº¥p giao tiáº¿p Modbus RTU qua UART Ä‘á»ƒ Ä‘iá»u khiá»ƒn vÃ  giÃ¡m sÃ¡t tá»« xa.

### 1.2. TÃ­nh nÄƒng chÃ­nh
- âœ… Äiá»u khiá»ƒn 2 Ä‘á»™ng cÆ¡ DC Ä‘á»™c láº­p
- âœ… 4 cháº¿ Ä‘á»™ Ä‘iá»u khiá»ƒn: ON/OFF, PID, Position, Calibration
- âœ… Giao tiáº¿p Modbus RTU (RS485) vá»›i baudrate tÃ¹y chá»‰nh
- âœ… Encoder quang há»c 1 kÃªnh vá»›i DMA Ä‘á»ƒ Ä‘o vá»‹ trÃ­
- âœ… 4 Digital Input vá»›i chá»©c nÄƒng gÃ¡n linh hoáº¡t
- âœ… 2 Digital Output (relay)
- âœ… Äo chiá»u dÃ i dÃ¢y xáº£ vá»›i thuáº­t toÃ¡n phi tuyáº¿n
- âœ… Há»‡ Ä‘iá»u hÃ nh thá»i gian thá»±c FreeRTOS

### 1.3. ThÃ´ng sá»‘ ká»¹ thuáº­t
| ThÃ´ng sá»‘ | GiÃ¡ trá»‹ |
|----------|---------|
| MCU | STM32F103C8T6 (ARM Cortex-M3, 72MHz) |
| Flash | 64KB |
| RAM | 20KB |
| Giao tiáº¿p | UART (Modbus RTU) |
| Baudrate | 9600 - 115200 bps |
| Sá»‘ Ä‘á»™ng cÆ¡ | 2 (Ä‘á»™c láº­p) |
| PWM Frequency | ~1kHz (TIM1, TIM3) |
| Encoder | 8 PPR (Pulse Per Revolution) |
| Äiá»‡n Ã¡p hoáº¡t Ä‘á»™ng | 5-24VDC |

---

## 2. PHáº¦N Cá»¨NG Sá»¬ Dá»¤NG

### 2.1. Vi Ä‘iá»u khiá»ƒn
```
STM32F103C8T6 (Blue Pill)
â”œâ”€ CPU: ARM Cortex-M3 @ 72MHz
â”œâ”€ Flash: 64KB
â”œâ”€ RAM: 20KB  
â”œâ”€ Timers: TIM1, TIM2, TIM3 (Advanced, General Purpose)
â”œâ”€ UART: USART2 (Modbus RTU)
â”œâ”€ I2C: I2C1 (dá»± phÃ²ng)
â””â”€ GPIO: 37 I/O pins
```

### 2.2. SÆ¡ Ä‘á»“ chÃ¢n (Pinout)

#### 2.2.1. Motor 1 Control
```
PA4  â”€â”€â”€â–º DIR_1       (Direction control - GPIO Output)
PA6  â”€â”€â”€â–º PWM_1       (TIM3_CH1 - PWM Output)
```

#### 2.2.2. Motor 2 Control
```
PA9  â”€â”€â”€â–º DIR_3       (Direction control - GPIO Output)
PA8  â”€â”€â”€â–º PWM_2A      (TIM1_CH1 - PWM Output)
PB14 â”€â”€â”€â–º PWM_2B      (TIM1_CH3 - PWM Output)
PB1  â”€â”€â”€â–º DIR_2       (Direction control - GPIO Output)
PB12 â”€â”€â”€â–º DIR_4       (Direction control - GPIO Output)
```

#### 2.2.3. Encoder Interface
```
PA0  â”€â”€â”€â–º ENCODER_A   (TIM2_CH1 - Input Capture + DMA)
                      â””â”€ Falling edge trigger
                      â””â”€ DMA1 Channel 5
```

#### 2.2.4. Digital I/O
```
Digital Inputs (GPIO Input):
â”œâ”€ PA5  â”€â”€â”€â–º IN1      (Origin sensor / Limit switch)
â”œâ”€ PB13 â”€â”€â”€â–º IN2      (Digital Input 2)
â””â”€ PB14 â”€â”€â”€â–º IN3      (Digital Input 3)

Digital Outputs (GPIO Output):
â”œâ”€ PB3  â”€â”€â”€â–º OUT1     (Relay/LED 1)
â””â”€ PB4  â”€â”€â”€â–º OUT2     (Relay/LED 2)
```

#### 2.2.5. Communication
```
PA2  â”€â”€â”€â–º TX          (USART2_TX - Modbus)
PA3  â”€â”€â”€â–º RX          (USART2_RX - Modbus)
```

#### 2.2.6. Status LEDs
```
PC13 â”€â”€â”€â–º LED4        (System heartbeat)
PC14 â”€â”€â”€â–º LED3        (Modbus activity)
PC15 â”€â”€â”€â–º LED2        (Status indicator)
```

### 2.3. Driver Ä‘á»™ng cÆ¡
```
Motor Driver IC: L298N hoáº·c tÆ°Æ¡ng Ä‘Æ°Æ¡ng
â”œâ”€ Input: DIR (direction) + PWM (speed)
â”œâ”€ Output: H-Bridge Ä‘á»ƒ Ä‘iá»u khiá»ƒn Ä‘á»™ng cÆ¡ DC
â””â”€ Protection: Overcurrent, thermal shutdown
```

### 2.4. Encoder
```
Optical Encoder: 8 slots (8 PPR)
â”œâ”€ Output: Channel A only (1-channel)
â”œâ”€ Type: Incremental, open collector
â”œâ”€ Signal: Digital pulse on falling edge
â””â”€ Connection: PA0 (TIM2_CH1)
```

### 2.5. SÆ¡ Ä‘á»“ khá»‘i pháº§n cá»©ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STM32F103C8T6                              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ USART2   â”‚    â”‚  TIM1/3  â”‚    â”‚   TIM2   â”‚                â”‚
â”‚  â”‚ Modbus   â”‚    â”‚   PWM    â”‚    â”‚ Encoder  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚
â”‚       â”‚               â”‚               â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â”‚               â”‚               â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ RS485   â”‚     â”‚ Motor   â”‚    â”‚ Optical â”‚
   â”‚ Module  â”‚     â”‚ Driver  â”‚    â”‚ Encoder â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ L298N   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                        â”‚
                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                   â”‚ DC      â”‚
                   â”‚ Motors  â”‚
                   â”‚ (x2)    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. SÆ  Äá»’ KIáº¾N TRÃšC PHáº¦N Má»€M

### 3.1. Kiáº¿n trÃºc RTOS (FreeRTOS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FreeRTOS Kernel                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  UartTask    â”‚  â”‚  MotorTask   â”‚  â”‚ EncoderTask  â”‚        â”‚
â”‚  â”‚  Priority: 3 â”‚  â”‚  Priority: 2 â”‚  â”‚ Priority: 1  â”‚        â”‚
â”‚  â”‚  Period: 10msâ”‚  â”‚  Period: 30msâ”‚  â”‚ Period: 10ms â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                 â”‚                 â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                           â”‚                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â”‚   Modbus Holding Registers        â”‚                  â”‚
â”‚         â”‚   (Global Shared Memory)          â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚  IOTask      â”‚  â”‚ VisibleTask  â”‚                           â”‚
â”‚  â”‚  Priority: 2 â”‚  â”‚  Priority: 2 â”‚                           â”‚
â”‚  â”‚  Period:500msâ”‚  â”‚  Period:250msâ”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2. Tasks vÃ  Æ°u tiÃªn

| Task | Priority | Period | Chá»©c nÄƒng |
|------|----------|--------|-----------|
| **UartTask** | High (3) | 10ms | Xá»­ lÃ½ Modbus RTU, nháº­n/tráº£ lá»i frames |
| **MotorTask** | Normal (2) | 30ms | Äiá»u khiá»ƒn Ä‘á»™ng cÆ¡, PID, position control |
| **EncoderTask** | Low (1) | 10ms | Äá»c encoder, tÃ­nh toÃ¡n vá»‹ trÃ­ |
| **IOTask** | Normal (2) | 500ms | Äá»c digital input, Ä‘iá»u khiá»ƒn output |
| **VisibleTask** | Normal2 (2) | 250ms | LED indicator, heartbeat |

### 3.3. Luá»“ng dá»¯ liá»‡u

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Modbus Masterâ”‚ (PC/PLC/HMI)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ UART (Modbus RTU)
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UartTask                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Nháº­n Modbus frame (UART IT + DMA)              â”‚ â”‚
â”‚  â”‚ 2. Kiá»ƒm tra CRC                                    â”‚ â”‚
â”‚  â”‚ 3. Xá»­ lÃ½ function code (03, 06, 16)               â”‚ â”‚
â”‚  â”‚ 4. Äá»c/ghi Holding Registers                      â”‚ â”‚
â”‚  â”‚ 5. Tráº£ vá» response                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ g_holdingRegisters[] (Shared memory)
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MotorTask                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Load: Modbus registers â†’ Motor structure       â”‚ â”‚
â”‚  â”‚ 2. Process:                                        â”‚ â”‚
â”‚  â”‚    - Control mode selection (ONOFF/PID/POSITION)  â”‚ â”‚
â”‚  â”‚    - PID calculation                               â”‚ â”‚
â”‚  â”‚    - Position control                              â”‚ â”‚
â”‚  â”‚    - PWM output                                    â”‚ â”‚
â”‚  â”‚ 3. Save: Motor structure â†’ Modbus registers       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²
       â”‚ motor1.Position_Current (from encoder)
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   EncoderTask                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Read: DMA pulse count â†’ Encoder structure      â”‚ â”‚
â”‚  â”‚ 2. Calculate:                                      â”‚ â”‚
â”‚  â”‚    - Linear position (mm)                          â”‚ â”‚
â”‚  â”‚    - Spool radius (nonlinear model)                â”‚ â”‚
â”‚  â”‚    - Wire length                                   â”‚ â”‚
â”‚  â”‚ 3. Save: Encoder structure â†’ Modbus registers     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. SÆ  Äá»’ GIáº¢I THUáº¬T

### 4.1. SÆ¡ Ä‘á»“ tá»•ng quan há»‡ thá»‘ng

```
START
  â”‚
  â”œâ”€â–º HAL_Init()
  â”‚
  â”œâ”€â–º SystemClock_Config() (72MHz)
  â”‚
  â”œâ”€â–º Peripheral Init:
  â”‚   â”œâ”€ GPIO
  â”‚   â”œâ”€ UART2 (Modbus)
  â”‚   â”œâ”€ TIM1/TIM3 (PWM)
  â”‚   â”œâ”€ TIM2 (Input Capture + DMA)
  â”‚   â””â”€ I2C1
  â”‚
  â”œâ”€â–º initializeModbusRegisters()
  â”‚
  â”œâ”€â–º Encoder_Init()
  â”‚
  â”œâ”€â–º osKernelInitialize()
  â”‚
  â”œâ”€â–º Create Tasks:
  â”‚   â”œâ”€ UartTask
  â”‚   â”œâ”€ MotorTask
  â”‚   â”œâ”€ EncoderTask
  â”‚   â”œâ”€ IOTask
  â”‚   â””â”€ VisibleTask
  â”‚
  â””â”€â–º osKernelStart()
      â”‚
      â””â”€â–º [RTOS Scheduler Running]
```

### 4.2. SÆ¡ Ä‘á»“ UartTask (Modbus Communication)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UartTask                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    [Wait for frame]
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ frameReceived?   â”‚â”€â”€â”€â”€Noâ”€â”€â”€â–º [Delay 10ms]
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
            â”‚ Yes                     â”‚
            â–¼                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚ Check Device ID  â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
            â”‚                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚ Verify CRC       â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
            â”‚                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚ Parse Function   â”‚              â”‚
    â”‚ Code (FC)        â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
            â”‚                         â”‚
      â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
      â”‚     â”‚     â”‚             â”‚    â”‚
FC=03 â”‚ FC=06 â”‚ FC=16         FC=?  â”‚
      â”‚     â”‚     â”‚             â”‚    â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â” â”Œâ”€â–¼â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â” â”‚
â”‚ Read  â”‚ â”‚Writeâ”‚ â”‚Writeâ”‚   â”‚Error â”‚ â”‚
â”‚ Regs  â”‚ â”‚Reg  â”‚ â”‚Multiâ”‚   â”‚Code  â”‚ â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜ â””â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”˜ â”‚
    â”‚       â”‚     â”‚            â”‚    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
            â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ Build Response   â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
            â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ Calculate CRC    â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
            â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ UART Transmit    â”‚            â”‚
    â”‚ (with mutex)     â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
            â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ Reset RX buffer  â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
            â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3. SÆ¡ Ä‘á»“ MotorTask (Control Loop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MotorTask (30ms)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Load registers   â”‚
    â”‚ â†’ motor1, motor2 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Motor1.Enable?   â”‚â”€â”€Noâ”€â”€â–º [Stop Motor1]
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
             â”‚ Yes               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚ Check Control    â”‚         â”‚
    â”‚ Mode             â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
             â”‚                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”  â”‚
      â”‚      â”‚        â”‚      â”‚  â”‚
  MODE=1  MODE=2  MODE=3  MODE=10â”‚
   ONOFF   PID   POSITION CALIB â”‚
      â”‚      â”‚        â”‚      â”‚  â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â” â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ–¼â”€â”â”‚
â”‚ON/OFF â”‚ â”‚ PID â”‚ â”‚ Pos  â”‚ â”‚Calâ”‚â”‚
â”‚Controlâ”‚ â”‚Loop â”‚ â”‚Ctrl  â”‚ â”‚ibâ”‚â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”¬â”€â”˜â”‚
    â”‚        â”‚        â”‚     â”‚  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜  â”‚
             â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚ Calculate PWM    â”‚       â”‚
    â”‚ Duty Cycle       â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
             â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚ Motor1_OutputPWM â”‚       â”‚
    â”‚ (TIM3_CH1)       â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
             â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚ Motor1_Set_Dir   â”‚       â”‚
    â”‚ (GPIO)           â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
             â”‚                 â”‚
    [Repeat for Motor2]        â”‚
             â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚ Save registers   â”‚       â”‚
    â”‚ â† motor1, motor2 â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
             â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚ Delay 30ms       â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
             â”‚                 â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4. SÆ¡ Ä‘á»“ chi tiáº¿t: ON/OFF Control Mode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Motor_HandleOnOff()             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Enable=1 AND     â”‚
    â”‚ Directionâ‰ IDLE?  â”‚â”€â”€Noâ”€â”€â–º [Stop PWM, duty=0]
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ Yes
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ duty = Command   â”‚
    â”‚ Speed Ã— 0.98     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Actual_Speed =   â”‚
    â”‚ duty             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Motor_OutputPWM  â”‚
    â”‚ (duty)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Motor_Set_Dir    â”‚
    â”‚ (Direction)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
            END
```

### 4.5. SÆ¡ Ä‘á»“ chi tiáº¿t: PID Control Mode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Motor_HandlePID()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Enable=1 AND     â”‚
    â”‚ Mode=PID?        â”‚â”€â”€Noâ”€â”€â–º [Reset PID state]
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
            â”‚ Yes                   â”‚
            â–¼                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ Read PID gains:  â”‚            â”‚
    â”‚ Kp, Ki, Kd       â”‚            â”‚
    â”‚ (scaled Ã·100)    â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ error =          â”‚            â”‚
    â”‚ Command_Speed -  â”‚            â”‚
    â”‚ Actual_Speed     â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ P_term = KpÃ—errorâ”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ integral +=      â”‚            â”‚
    â”‚ error Ã— dt       â”‚            â”‚
    â”‚ (anti-windup)    â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ I_term = KiÃ—     â”‚            â”‚
    â”‚ integral         â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ derivative =     â”‚            â”‚
    â”‚ (error-last_err) â”‚            â”‚
    â”‚ / dt             â”‚            â”‚
    â”‚ (filtered)       â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ D_term = KdÃ—     â”‚            â”‚
    â”‚ derivative       â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ output =         â”‚            â”‚
    â”‚ P+I+D            â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ Apply rate limit â”‚            â”‚
    â”‚ (Max_Acc)        â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ Clamp to         â”‚            â”‚
    â”‚ [0, Max_Speed]   â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ duty = output    â”‚            â”‚
    â”‚ Ã— 0.98           â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚ Motor_OutputPWM  â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
             â”‚                      â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.6. SÆ¡ Ä‘á»“ chi tiáº¿t: Position Control Mode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Motor_HandlePosition()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Enable=1 AND     â”‚
    â”‚ Mode=POSITION?   â”‚â”€â”€Noâ”€â”€â–º [Stop motor]
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ Yes
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ current_pos =    â”‚
    â”‚ Position_Current â”‚
    â”‚ (from encoder)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ target_pos =     â”‚
    â”‚ Position_Target  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ position_error = â”‚
    â”‚ target - current â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ abs_error =      â”‚
    â”‚ |pos_error|      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ abs_error <= 1?  â”‚â”€â”€Yesâ”€â–º [Stop motor at target]
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ No
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Determine        â”‚
    â”‚ direction:       â”‚
    â”‚ error>0â†’FORWARD  â”‚
    â”‚ error<0â†’REVERSE  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PID_Compute_Pos  â”‚
    â”‚ (setpoint_cm,    â”‚
    â”‚  feedback_cm)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Apply            â”‚
    â”‚ acceleration     â”‚
    â”‚ limiting         â”‚
    â”‚ (Max_Acc)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ duty = output    â”‚
    â”‚ Ã— 0.98           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Motor_OutputPWM  â”‚
    â”‚ Motor_Set_Dir    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
            END
```

### 4.7. SÆ¡ Ä‘á»“ EncoderTask (Position Measurement)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   EncoderTask (10ms)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Load encoder     â”‚
    â”‚ config           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Check origin     â”‚
    â”‚ sensor (IN1)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Read DMA counter â”‚
    â”‚ (__HAL_DMA_GET_  â”‚
    â”‚  COUNTER)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Calculate new    â”‚
    â”‚ pulses since     â”‚
    â”‚ last read        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Noise rejection: â”‚
    â”‚ - Too large?     â”‚
    â”‚ - Too small?     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Valid
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ pulse_count +=   â”‚
    â”‚ new_pulses       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Get motor        â”‚
    â”‚ direction        â”‚
    â”‚ (FORWARD/REVERSE)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ delta_revs =     â”‚
    â”‚ delta_ticks /    â”‚
    â”‚ Revolutions      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ current_circum = â”‚
    â”‚ 2Ã—Ï€Ã—Rmax         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ delta_length =   â”‚
    â”‚ circum Ã—         â”‚
    â”‚ delta_revs       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ unrolled_length  â”‚
    â”‚ += delta_length  â”‚
    â”‚ (with direction) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update radius    â”‚
    â”‚ (nonlinear model)â”‚
    â”‚ RÂ² âˆ remaining   â”‚
    â”‚ wire volume      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Apply low-pass   â”‚
    â”‚ filter           â”‚
    â”‚ (Î±=0.15)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Save encoder     â”‚
    â”‚ data to registersâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Delay 10ms       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [Loop]
```

### 4.8. CÃ´ng thá»©c tÃ­nh toÃ¡n chÃ­nh

#### 4.8.1. PID Standard Form
```
Output(t) = KpÃ—e(t) + KiÃ—âˆ«e(t)dt + KdÃ—de(t)/dt

Trong Ä‘Ã³:
- e(t) = setpoint - feedback (error)
- Kp, Ki, Kd Ä‘Æ°á»£c scale Ã—100 trong Modbus
- Sample time dt = 0.01s (10ms)
```

#### 4.8.2. Spool Radius Model (Nonlinear)
```
R(L) = âˆš(R_maxÂ² - (R_maxÂ² - R_minÂ²) Ã— (L / L_total))

Trong Ä‘Ã³:
- L = unrolled wire length (mm)
- R_max = 35mm (full spool)
- R_min = 20mm (empty core)
- L_total = 3000mm (total wire)

VÃ­ dá»¥:
L = 0mm    â†’ R = 35.0mm
L = 1500mm â†’ R = 25.5mm
L = 3000mm â†’ R = 20.0mm
```

#### 4.8.3. Encoder to Linear Position
```
Linear_displacement = 2Ã—Ï€Ã—R Ã— (pulses / PPR)

Trong Ä‘Ã³:
- R = current radius (mm)
- pulses = encoder count
- PPR = 8 (Pulses Per Revolution)
```

---

## 5. Báº¢N Äá»’ THANH GHI MODBUS

### 5.1. Tá»•ng quan
- **Protocol**: Modbus RTU
- **Function Codes**: 03 (Read), 06 (Write Single), 16 (Write Multiple)
- **Default Device ID**: 3
- **Default Baudrate**: 115200 bps
- **Total Registers**: 0x004E (78 registers)

### 5.2. System Registers (0x0100-0x0109)

| Address | Name | Type | R/W | Description | Default | Range |
|---------|------|------|-----|-------------|---------|-------|
| 0x0100 | Device_ID | uint16 | R/W | Modbus slave address | 3 | 1-247 |
| 0x0101 | Config_Baudrate | uint16 | R/W | 1=9600, 2=19200, 3=38400, 4=57600, 5=115200 | 5 | 1-5 |
| 0x0102 | Config_Parity | uint16 | R/W | 0=None, 1=Even, 2=Odd | 0 | 0-2 |
| 0x0103 | Config_Stop_Bit | uint16 | R/W | Stop bits (1 or 2) | 1 | 1-2 |
| 0x0104 | Module_Type | uint16 | R | Module type (3=Motor Driver) | 3 | - |
| 0x0105 | Firmware_Version | uint16 | R | Firmware version (0x0001 = v0.01) | 0x0001 | - |
| 0x0106 | Hardware_Version | uint16 | R | Hardware version | 0x0001 | - |
| 0x0107 | System_Status | uint16 | R | System status bitfield | 0x0000 | - |
| 0x0108 | System_Error | uint16 | R | Global error code | 0 | - |
| 0x0109 | Reset_Error_Command | uint16 | W | Write 1 to reset errors | 0 | 0-1 |

### 5.3. Motor 1 Registers (0x0000-0x000F)

| Address | Name | Type | R/W | Description | Default | Range |
|---------|------|------|-----|-------------|---------|-------|
| 0x0000 | M1_Control_Mode | uint16 | R/W | 1=ONOFF, 2=PID, 3=POSITION, 10=CALIB | 1 | 1-10 |
| 0x0001 | M1_Enable | uint16 | R/W | 0=OFF, 1=ON | 0 | 0-1 |
| 0x0002 | M1_Command_Speed | uint16 | R/W | Speed setpoint (%) | 0 | 0-100 |
| 0x0003 | M1_Actual_Speed | uint16 | R | Measured speed (%) | 0 | 0-100 |
| 0x0004 | M1_Direction | uint16 | R/W | 0=Idle, 1=Forward, 2=Reverse | 0 | 0-2 |
| 0x0005 | M1_Max_Speed | uint16 | R/W | Maximum speed limit (%) | 100 | 0-100 |
| 0x0006 | M1_Min_Speed | uint16 | R/W | Minimum speed limit (%) | 0 | 0-100 |
| 0x0007 | M1_PID_Kp | uint16 | R/W | PID Kp gain (Ã—100) | 100 | 0-1000 |
| 0x0008 | M1_PID_Ki | uint16 | R/W | PID Ki gain (Ã—100) | 10 | 0-1000 |
| 0x0009 | M1_PID_Kd | uint16 | R/W | PID Kd gain (Ã—100) | 5 | 0-1000 |
| 0x000A | M1_Max_Acceleration | uint16 | R/W | Max acceleration (%/s) | 5 | 1-100 |
| 0x000B | M1_Max_Deceleration | uint16 | R/W | Max deceleration (%/s) | 4 | 1-100 |
| 0x000C | M1_Status_Word | uint16 | R | Motor status flags | 0x0000 | - |
| 0x000D | M1_Error_Code | uint16 | R | Error code | 0 | - |
| 0x000E | M1_Position_Current | uint16 | R | Current position (cm) | 0 | 0-300 |
| 0x000F | M1_Position_Target | uint16 | R/W | Target position (cm) | 0 | 0-300 |

### 5.4. Motor 2 Registers (0x0010-0x001F)
*(Same structure as Motor 1, base address 0x0010)*

### 5.5. Digital Input Registers (0x0020-0x0025)

| Address | Name | Type | R/W | Description | Default | Range |
|---------|------|------|-----|-------------|---------|-------|
| 0x0020 | DI_Status_Word | uint16 | R | Digital input status (bit 0-3) | 0x0000 | 0-0x000F |
| 0x0021 | DI1_Assignment | uint16 | R/W | Function assignment for DI1 | 0 | 0-10 |
| 0x0022 | DI2_Assignment | uint16 | R/W | Function assignment for DI2 | 0 | 0-10 |
| 0x0023 | DI3_Assignment | uint16 | R/W | Function assignment for DI3 | 0 | 0-10 |
| 0x0024 | DI4_Assignment | uint16 | R/W | Function assignment for DI4 | 0 | 0-10 |
| 0x0025 | Current | uint16 | R | System current (Ã—100 A) | 0 | - |

**DI Assignment Values**:
- 0 = None
- 1 = Start M1
- 2 = Stop M1
- 3 = Reverse M1
- 4 = Fault Reset
- 5 = Mode Switch
- 6 = Start M2
- 7 = Stop M2
- 8 = Reverse M2
- 9 = Emergency Stop
- 10 = Jog Mode

### 5.6. Digital Output Registers (0x0030-0x0034)

| Address | Name | Type | R/W | Description | Default | Range |
|---------|------|------|-----|-------------|---------|-------|
| 0x0030 | DO_Status_Word | uint16 | R | Digital output status (bit 0-1) | 0x0000 | 0-0x0003 |
| 0x0031 | DO1_Control | uint16 | R/W | Control DO1 (0=off, 1=on) | 0 | 0-1 |
| 0x0032 | DO1_Assignment | uint16 | R/W | Function assignment for DO1 | 0 | 0-10 |
| 0x0033 | DO2_Control | uint16 | R/W | Control DO2 (0=off, 1=on) | 0 | 0-1 |
| 0x0034 | DO2_Assignment | uint16 | R/W | Function assignment for DO2 | 0 | 0-10 |

### 5.7. Encoder Registers (0x0040-0x004D)

| Address | Name | Type | R/W | Description | Default | Range |
|---------|------|------|-----|-------------|---------|-------|
| 0x0040 | Encoder_Status_Word | uint16 | R | Encoder status flags | 0x0000 | - |
| 0x0041 | Encoder_Count | uint16 | R | Current pulse count | 0 | 0-65535 |
| 0x0042 | Encoder_Revolutions | uint16 | R/W | Pulses per revolution | 8 | 1-100 |
| 0x0043 | Encoder_Rmax | uint16 | R/W | Maximum spool radius (mm) | 35 | 10-100 |
| 0x0044 | Encoder_Rmin | uint16 | R/W | Minimum spool radius (mm) | 20 | 5-50 |
| 0x0045 | Encoder_Wire_Length_CM | uint16 | R/W | Total wire length (cm) | 300 | 10-1000 |
| 0x0046 | Encoder_Reset | uint16 | W | Write 1 to reset counter | 0 | 0-1 |
| 0x0048 | Encoder_Calib_Wire_Length_CM | uint16 | R/W | Calibration length (cm) | 300 | 10-1000 |
| 0x004A | Encoder_Calib_Status | uint16 | R | Calibration status | 0 | 0-3 |
| 0x004B | Encoder_Calib_Current_Length_CM | uint16 | R | Current measured length (cm) | 0 | 0-1000 |
| 0x004C | Encoder_Calib_Origin_Status | uint16 | R | Origin sensor status (0/1) | 0 | 0-1 |
| 0x004D | Encoder_Unrolled_Wire_Length_CM | uint16 | R | Calculated wire length (cm) | 0 | 0-1000 |

---

## 6. CHI TIáº¾T CHá»¨C NÄ‚NG

### 6.1. CÃ¡c cháº¿ Ä‘á»™ Ä‘iá»u khiá»ƒn Ä‘á»™ng cÆ¡

#### 6.1.1. ON/OFF Mode (Mode 1)
- **MÃ´ táº£**: Äiá»u khiá»ƒn Ä‘Æ¡n giáº£n, PWM duty = Command Speed
- **á»¨ng dá»¥ng**: Di chuyá»ƒn vá»›i tá»‘c Ä‘á»™ cá»‘ Ä‘á»‹nh
- **Registers**:
  - M1_Control_Mode = 1
  - M1_Enable = 1
  - M1_Command_Speed = 0-100 (%)
  - M1_Direction = 1 (Forward) hoáº·c 2 (Reverse)
- **Thuáº­t toÃ¡n**:
  ```c
  if (Enable && Direction != IDLE) {
      duty = Command_Speed Ã— 0.98;
      PWM_Output(duty);
  }
  ```

#### 6.1.2. PID Mode (Mode 2)
- **MÃ´ táº£**: Äiá»u khiá»ƒn tá»‘c Ä‘á»™ vá»›i vÃ²ng kÃ­n PID
- **á»¨ng dá»¥ng**: Duy trÃ¬ tá»‘c Ä‘á»™ á»•n Ä‘á»‹nh dÃ¹ cÃ³ thay Ä‘á»•i táº£i
- **Registers**:
  - M1_Control_Mode = 2
  - M1_PID_Kp = 100 (Kp = 1.00)
  - M1_PID_Ki = 10 (Ki = 0.10)
  - M1_PID_Kd = 5 (Kd = 0.05)
  - M1_Max_Acceleration = 5 (%/s)
- **Thuáº­t toÃ¡n**:
  ```c
  error = Command_Speed - Actual_Speed;
  P = Kp Ã— error;
  I = Ki Ã— âˆ«error dt (with anti-windup);
  D = Kd Ã— d(error)/dt (with filter);
  output = P + I + D;
  output = rate_limit(output, Max_Acceleration);
  PWM_Output(clamp(output, 0, 100));
  ```

#### 6.1.3. Position Mode (Mode 3)
- **MÃ´ táº£**: Äiá»u khiá»ƒn vá»‹ trÃ­ dá»±a trÃªn encoder
- **á»¨ng dá»¥ng**: Di chuyá»ƒn chÃ­nh xÃ¡c Ä‘áº¿n vá»‹ trÃ­ mong muá»‘n
- **Registers**:
  - M1_Control_Mode = 3
  - M1_Position_Target = 150 (cm)
  - M1_Position_Current = (auto from encoder)
  - M1_Command_Speed = 50 (max speed %)
- **Thuáº­t toÃ¡n**:
  ```c
  position_error = Position_Target - Position_Current;
  if (|position_error| <= 1 cm) {
      Stop_Motor();
  } else {
      direction = (position_error > 0) ? FORWARD : REVERSE;
      speed = PID_Compute_Position(target, current);
      speed = rate_limit(speed, Max_Acceleration);
      PWM_Output(speed);
  }
  ```

#### 6.1.4. Calibration Mode (Mode 10)
- **MÃ´ táº£**: Tá»± Ä‘á»™ng hiá»‡u chá»‰nh chiá»u dÃ i dÃ¢y
- **á»¨ng dá»¥ng**: XÃ¡c Ä‘á»‹nh chiá»u dÃ i thá»±c táº¿ cá»§a dÃ¢y
- **Quy trÃ¬nh**:
  1. Di chuyá»ƒn vá» vá»‹ trÃ­ gá»‘c (REVERSE Ä‘áº¿n khi sensor active)
  2. Reset encoder count
  3. Xáº£ dÃ¢y theo khoáº£ng cÃ¡ch hiá»‡u chá»‰nh (FORWARD)
  4. Ghi láº¡i chiá»u dÃ i thá»±c táº¿
  5. Quay vá» vá»‹ trÃ­ gá»‘c

### 6.2. Encoder vÃ  Ä‘o vá»‹ trÃ­

#### 6.2.1. Input Capture vá»›i DMA
- **Hardware**: TIM2_CH1 + DMA1_Channel5
- **Mode**: Circular DMA
- **Trigger**: Falling edge
- **Buffer Size**: 100 pulses
- **Advantages**:
  - KhÃ´ng máº¥t xung khi CPU báº­n
  - Äá»™ chÃ­nh xÃ¡c cao
  - Overhead CPU tháº¥p

#### 6.2.2. Noise Rejection
```c
#define NOISE_THRESHOLD_TICKS 2
#define MAX_DELTA_PER_CYCLE 500

if (new_pulses > MAX_DELTA_PER_CYCLE) {
    reject(); // QuÃ¡ lá»›n, cÃ³ thá»ƒ nhiá»…u
}
if (new_pulses < NOISE_THRESHOLD_TICKS && new_pulses > 0) {
    reject(); // QuÃ¡ nhá», bá» qua
}
```

#### 6.2.3. Nonlinear Spool Model
- **Problem**: BÃ¡n kÃ­nh cuá»™n dÃ¢y giáº£m khi xáº£ dÃ¢y
- **Solution**: MÃ´ hÃ¬nh phi tuyáº¿n dá»±a trÃªn diá»‡n tÃ­ch
  ```
  R(L) = âˆš(R_maxÂ² - (R_maxÂ² - R_minÂ²) Ã— (L / L_total))
  ```
- **Accuracy**: Cao hÆ¡n 15-20% so vá»›i mÃ´ hÃ¬nh tuyáº¿n tÃ­nh

### 6.3. Communication (Modbus RTU)

#### 6.3.1. Frame Format
```
[Device_ID][Function][Address_H][Address_L][Data...][CRC_L][CRC_H]
```

#### 6.3.2. Supported Function Codes
- **FC 03**: Read Holding Registers
  ```
  Request:  [ID][03][Addr_H][Addr_L][Qty_H][Qty_L][CRC_L][CRC_H]
  Response: [ID][03][Byte_Count][Data...][CRC_L][CRC_H]
  ```
- **FC 06**: Write Single Register
  ```
  Request:  [ID][06][Addr_H][Addr_L][Val_H][Val_L][CRC_L][CRC_H]
  Response: [Echo request]
  ```
- **FC 16**: Write Multiple Registers
  ```
  Request:  [ID][16][Addr_H][Addr_L][Qty_H][Qty_L][Byte_Count][Data...][CRC_L][CRC_H]
  Response: [ID][16][Addr_H][Addr_L][Qty_H][Qty_L][CRC_L][CRC_H]
  ```

#### 6.3.3. Timing
- **Baud Rate**: Configurable (9600 - 115200)
- **Frame Timeout**: 3.5 character time
- **Response Time**: < 100ms typical

---

## 7. HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG

### 7.1. Khá»Ÿi Ä‘á»™ng há»‡ thá»‘ng

```python
# 1. Káº¿t ná»‘i Modbus
modbus = ModbusClient(port='COM3', baudrate=115200)

# 2. Äá»c thÃ´ng tin há»‡ thá»‘ng
device_id = modbus.read_holding_registers(0x0100, 1)
firmware_ver = modbus.read_holding_registers(0x0105, 1)
print(f"Device ID: {device_id}, Firmware: v{firmware_ver:04X}")

# 3. Reset lá»—i (náº¿u cÃ³)
modbus.write_register(0x0109, 1)
```

### 7.2. Äiá»u khiá»ƒn Motor ON/OFF

```python
# Khá»Ÿi Ä‘á»™ng Motor 1 á»Ÿ cháº¿ Ä‘á»™ ON/OFF
modbus.write_register(0x0000, 1)        # Control_Mode = ONOFF
modbus.write_register(0x0001, 1)        # Enable = ON
modbus.write_register(0x0004, 1)        # Direction = FORWARD
modbus.write_register(0x0002, 50)       # Command_Speed = 50%

# Äá»c tá»‘c Ä‘á»™ thá»±c táº¿
actual_speed = modbus.read_holding_registers(0x0003, 1)
print(f"Actual Speed: {actual_speed}%")

# Dá»«ng motor
modbus.write_register(0x0001, 0)        # Enable = OFF
```

### 7.3. Äiá»u khiá»ƒn Motor vá»›i PID

```python
# Cáº¥u hÃ¬nh PID
modbus.write_register(0x0000, 2)        # Control_Mode = PID
modbus.write_register(0x0007, 100)      # PID_Kp = 1.00
modbus.write_register(0x0008, 10)       # PID_Ki = 0.10
modbus.write_register(0x0009, 5)        # PID_Kd = 0.05
modbus.write_register(0x000A, 5)        # Max_Acceleration = 5%/s

# Khá»Ÿi Ä‘á»™ng vá»›i tá»‘c Ä‘á»™ má»¥c tiÃªu
modbus.write_register(0x0001, 1)        # Enable = ON
modbus.write_register(0x0004, 1)        # Direction = FORWARD
modbus.write_register(0x0002, 70)       # Command_Speed = 70%

# Monitor PID performance
while True:
    cmd_speed = modbus.read_holding_registers(0x0002, 1)
    act_speed = modbus.read_holding_registers(0x0003, 1)
    print(f"Setpoint: {cmd_speed}%, Actual: {act_speed}%")
    time.sleep(0.1)
```

### 7.4. Äiá»u khiá»ƒn vá»‹ trÃ­

```python
# Cáº¥u hÃ¬nh Position Mode
modbus.write_register(0x0000, 3)        # Control_Mode = POSITION
modbus.write_register(0x0002, 40)       # Command_Speed = 40% (max)
modbus.write_register(0x000A, 3)        # Max_Acceleration = 3%/s

# Di chuyá»ƒn Ä‘áº¿n vá»‹ trÃ­ 150cm
modbus.write_register(0x0001, 1)        # Enable = ON
modbus.write_register(0x000F, 150)      # Position_Target = 150cm

# GiÃ¡m sÃ¡t vá»‹ trÃ­
while True:
    current_pos = modbus.read_holding_registers(0x000E, 1)
    target_pos = modbus.read_holding_registers(0x000F, 1)
    print(f"Position: {current_pos}/{target_pos} cm")
    
    if current_pos == target_pos:
        print("Target reached!")
        break
    
    time.sleep(0.2)
```

### 7.5. Calibration

```python
# Thá»±c hiá»‡n calibration
modbus.write_register(0x0048, 300)      # Calib_Wire_Length = 300cm
modbus.write_register(0x0000, 10)       # Control_Mode = CALIB
modbus.write_register(0x0002, 30)       # Command_Speed = 30%
modbus.write_register(0x0001, 1)        # Enable = ON (báº¯t Ä‘áº§u calib)

# GiÃ¡m sÃ¡t quÃ¡ trÃ¬nh calibration
while True:
    calib_status = modbus.read_holding_registers(0x004A, 1)
    current_length = modbus.read_holding_registers(0x004B, 1)
    origin_status = modbus.read_holding_registers(0x004C, 1)
    
    print(f"Calib Status: {calib_status}, Length: {current_length}cm, Origin: {origin_status}")
    
    if calib_status == 1:
        print("Calibration completed!")
        break
    
    time.sleep(0.5)
```

### 7.6. Äá»c Encoder

```python
# Äá»c dá»¯ liá»‡u encoder
encoder_count = modbus.read_holding_registers(0x0041, 1)
wire_length = modbus.read_holding_registers(0x004D, 1)
origin_status = modbus.read_holding_registers(0x004C, 1)

print(f"Encoder Count: {encoder_count}")
print(f"Wire Length: {wire_length} cm")
print(f"Origin Sensor: {'Active' if origin_status else 'Inactive'}")

# Reset encoder
modbus.write_register(0x0046, 1)        # Encoder_Reset = 1
```

---

## 8. PHá»¤ Lá»¤C

### 8.1. Troubleshooting

| Váº¥n Ä‘á» | NguyÃªn nhÃ¢n | Giáº£i phÃ¡p |
|--------|-------------|-----------|
| KhÃ´ng nháº­n Modbus | Sai Device ID hoáº·c baudrate | Kiá»ƒm tra 0x0100, 0x0101 |
| Motor khÃ´ng quay | Enable=0 hoáº·c Direction=IDLE | Set Enable=1, Directionâ‰ 0 |
| PID dao Ä‘á»™ng | Kp quÃ¡ cao | Giáº£m Kp, tÄƒng Kd |
| PID cháº­m Ä‘áº¡t setpoint | Ki quÃ¡ tháº¥p | TÄƒng Ki |
| Encoder khÃ´ng Ä‘áº¿m | Káº¿t ná»‘i encoder | Kiá»ƒm tra PA0, nguá»“n encoder |
| Vá»‹ trÃ­ khÃ´ng chÃ­nh xÃ¡c | ChÆ°a calibration | Cháº¡y Calibration Mode |

### 8.2. Performance Tips

1. **PID Tuning**: Báº¯t Ä‘áº§u vá»›i Kp=100, Ki=10, Kd=5, sau Ä‘Ã³ Ä‘iá»u chá»‰nh
2. **Acceleration Limit**: GiÃ¡ trá»‹ tháº¥p (3-5) cho chuyá»ƒn Ä‘á»™ng mÆ°á»£t, cao (10-20) cho pháº£n há»“i nhanh
3. **Position Mode**: Sá»­ dá»¥ng Command_Speed tháº¥p (30-50%) Ä‘á»ƒ chÃ­nh xÃ¡c cao
4. **Encoder Noise**: Náº¿u nhiá»…u nhiá»u, tÄƒng NOISE_THRESHOLD_TICKS

### 8.3. Version History

| Version | Date | Changes |
|---------|------|---------|
| v0.01 | 2025-01 | Initial release |
| | | - Dual motor control |
| | | - Modbus RTU |
| | | - 4 control modes |
| | | - Encoder with DMA |

---

## 9. LIÃŠN Há»† & Há»– TRá»¢

- **Email**: support@raybot.com
- **GitHub**: https://github.com/raybot/dc-driver
- **Documentation**: https://docs.raybot.com/dc-driver

---

**Â© 2025 RAYBOT - DC Driver Module Documentation v1.0**
